function Player(a,b,c,d){this._x=a,this._y=b,this._radius=c,this._diameter=2*c,this._status=0,this._game=d,this._speed=0,this._acceration=.4,this._direction=0,this._keyTimer=null,this._pir2=2*Math.PI,this._lastKey=0}function Item(a,b){this._game=b;var d=Math.random();this._number=1;var e=.7,f=Math.floor(7*d);switch(f){case 0:this._fillStyle="rgba(255,0,0,"+e+")";break;case 1:this._fillStyle="rgba(255,165,0,"+e+")";break;case 2:this._fillStyle="rgba(255,255,0,"+e+")";break;case 3:this._fillStyle="rgba(0,128,0,"+e+")";break;case 4:this._fillStyle="rgba(0,0,255,"+e+")";break;case 5:this._fillStyle="rgba(75,0,130,"+e+")";break;case 6:this._fillStyle="rgba(238,130,238,"+e+")";break;default:this._fillStyle="rgba(255,255,255,"+e+")"}this._x=1e3,this._y=Math.abs(a+(Math.floor(401*d)-200))%400,this.isLeave=!1,this.isCollect=!1,this._x2=0,this._y2=0}function Floor(a,b,c,d,e){var f=Math.random();if(2==arguments.length){this._x=1e3,this._y=Math.abs(arguments[0]+(Math.floor(501*f)-250))%500,this._game=arguments[1];var g=400+800/(1+this._game._score/1e3);this._width=Math.floor(f*g)+g/4,this._height=Math.floor(40*f)+20,this._speed=2*f+.1,this._fillStyle="rgba(136,136,136,"+(.3+.7*f)+")"}else 5==arguments.length&&(this._x=a,this._y=Math.abs(b),this._width=c,this._height=d,this._game=e,this._speed=1,this._fillStyle="rgba(136,136,136,0.7)");this.isLeave=!1}function Game(){this._updateInterval=50,this._accelInterval=500,this._canvas=null,this._canvasContext=null,this._canvasBuffer=null,this._canvasBufferContext=null,this._width=0,this._height=0,this._floor=[],this._item=[],this._speed=2,this._isPause=!1,this._drawTimer=null,this._speedTimer=null,this._floorTimer=null,this._itemTimer=null,this._scoreTimer=null,this._isRunning=!1,this._standingPlatform=null,this._player=null,this._score=0,this._score_box=$("#score"),this._multiplier=1,this._mul_box=$("#multiplier"),this._grand=0,this._grand_box=$("#grand_total"),this._mix=0,this._mix_box=$("#mix"),this._isLost=!1,this._audio=$("#audio")[0]}function login(){FB.login(function(a){a.session&&(a.perms?window.location.reload(!1):$("#status").html("...if you'd given enough permission!"))},{perms:"publish_stream"})}Player.prototype={Update:function(){var b=this._game,c=b._standingPlatform;if(0!==this._direction){this._speed+=this._direction*this._acceration;var d=Math.floor(this._direction*this._speed);if(d>0){if(c&&Math.abs(c._y-this._y)<this._radius&&c._x<=this._x&&c._x+c._width>=this._x+this._radius)return this._y=c._y-this._radius,this._direction=0,this._speed=0,void 0;for(var e=1;d+this._radius>e;e++){var f=this._y+e,g=b._floor[f];if(g)for(var h=g.length;h--;){var i=g[h];if(i._x<=this._x&&i._x+i._width>=this._x+this._radius)return b._standingPlatform=i,this._y=f-this._radius,this._direction=0,this._speed=0,void 0}}}if(this._y+=d,this._y>500)return b.onLost(),void 0}else c&&(0>c._width||c._x>this._x||c._x+c._width<this._x-this._radius)&&(this._direction=1,b._standingPlatform=null)},moveLeft:function(){this._x>=3&&(this._x-=2)},moveRight:function(){9997>=this._x&&(this._x+=2)},Jump:function(a){this._direction=-1,this._speed=a>10?10:5>a?5:a},Drop:function(){this._direction=1,this._y+=this._diameter+1,this._game._standingPlatform=null},handleKey:function(a){var b=a.keyCode;if("keyup"==a.type)clearInterval(this._keyTimer),this._keyTimer=null;else switch(b){case 38:this._direction||this.Jump(50*this._game._speed/this._game._updateInterval),a.stopPropagation(),a.preventDefault();break;case 37:65!=this._lastKey&&this._keyTimer&&(clearInterval(this._keyTimer),this._keyTimer=null),this._keyTimer||(this.moveLeft(),this._keyTimer=setInterval(function(a){a.moveLeft()},12,this)),this._lastKey=65,a.stopPropagation(),a.preventDefault();break;case 39:68!=this._lastKey&&this._keyTimer&&(clearInterval(this._keyTimer),this._keyTimer=null),this._keyTimer||(this.moveRight(),this._keyTimer=setInterval(function(a){a.moveRight()},12,this)),this._lastKey=68,a.stopPropagation(),a.preventDefault();break;case 40:this._direction||this.Drop(),a.stopPropagation(),a.preventDefault()}},Draw:function(a){a.fillStyle="rgba(100,100,100,0.3)",a.beginPath(),a.arc(this._x,this._y,this._radius,0,this._pir2,!0),a.closePath(),a.fill()}},Item.prototype={Update:function(a){if(this.isCollect)return this._x+=this._x2,this._y+=this._y2,this._x>=990&&this._y>=490&&(setTimeout(function(a){return function(){a._game.onCollect(a)}}(this),10),this.isLeave=!0),void 0;var b=this._x;b-=a;var c=this._game._player,d=Math.sqrt((this._x+9-c._x)*(this._x+9-c._x)+(this._y-13-c._y)*(this._y-13-c._y));if(c._diameter>=d){this.isCollect=!0;var e=a/2;this._x2=e*((990-this._x)/(490-this._y)),this._y2=e,setTimeout(function(a){return function(){a._game.onHit(a)}}(this),10)}b>=0?this._x=b:(this.isLeave=!0,this._x=0)},Draw:function(a){a.font="900 3em 'Droid Sans',Arial,Helvetica,sans-serif",a.fillStyle=this._fillStyle,a.fillText("V",this._x,this._y)}},Floor.prototype={Update:function(a){var b=this._x;b-=this._speed*a,b>=0?this._x=b:(this._width+=b,this._x=0,0>=this._width&&(this.isLeave=!0,setTimeout(function(a){return function(){a._game.onFloorLeave(a)}}(this),10)))},Draw:function(a){a.fillStyle=this._fillStyle,a.fillRect(this._x,this._y,this._width,this._height)}},Game.prototype={showPopup:function(a){if(1!=arguments.length||null==a||1>a.length())var a="Vitamin A is good for your eyes";var b=$(".popup"),c=["blind","clip","drop","explode","fold","puff","slide","scale","size","pulsate"],d=c[Math.floor(Math.random()*c.length)];b.html(a),b.show(),b.position({of:$("#main_container"),my:"center center",at:"center center",offset:"0 0",collision:"none none"}),b.show(d,{},1e3)},post2fb:function(){console.log("post2fb"),FB.ui({method:"stream.publish",attachment:{name:"It is better when comes in 10",caption:"score: "+this._score,description:caption,media:[{type:"image",src:data.data.url,href:link_href}]},action_links:[{text:"Rate back!",href:"http://aagpxm9q.facebook.joyent.us/fb/yours/"}],user_prompt_message:"What' your verdict?"},function(a){a&&a.post_id?$("#status").html("Post was published."):$("#status").html("Post was not published.")})},onHit:function(){},onLost:function(){$(document).unbind("focusout"),$(window).unbind("blur"),this.stopMusic(),clearInterval(this._drawTimer),clearInterval(this._itemTimer),clearInterval(this._scoreTimer),this._isLost=!0,$("#score2").html((""+this._grand).replace(/\B(?=(?:\d{3})+(?!\d))/g,",")),$("#submit_text").hover(function(){$("#facebook").show(),$("#score2").hide()},function(){$("#facebook").hide(),$("#score2").show()}),$(document).unbind("keyup keydown"),$("#mix").hide(),$(".imix_info").slideDown("slow"),$("#canvas").hide(),$("#main_container").animate({height:"-=230"},1e3),$(".overlay .text .lost").show(),$(".overlay .text .before_start").hide(),$("#main_container .overlay").fadeIn("fast"),$("#score_container").hide()},onCollect:function(a){var b=this._mix+a._number;b>10?(b=0,this._multiplier>1&&this._multiplier--):10==b&&(b=0,this._multiplier++),this._mix=b,this._mix_box.html(this._mix),this.showPopup()},onFloorLeave:function(a){if(Math.random()>.65){var b=new Floor(a._y,this);this._floor[b._y].push(b)}},stopMusic:function(){this._audio.pause()},Init:function(){if(this._canvas=document.getElementById("canvas"),this._canvas&&this._canvas.getContext){this._canvasContext=this._canvas.getContext("2d"),this._canvasBuffer=document.getElementById("buffer_canvas"),this._width=this._canvas.width,this._canvasBuffer.width=this._canvas.width,this._height=this._canvas.height,this._canvasBuffer.height=this._canvas.height,this._canvasBufferContext=this._canvasBuffer.getContext("2d");for(var a=this._height+1;a--;)this._floor[a-1]=[],this._item[a-1]=[];var b=new Floor(0,this._height/2,this._width,250,this);return this._standingPlatform=b,this._floor[this._height/2].push(b),this._player=new Player(this._width/2,this._height/2-10,10,this),this._isPause=!0,this.Update(),this._isPause=!1,$(document).bind("keyup",function(a){return function(b){a.handleKey(b)}}(this)),$("#main_container").click(function(a){return function(b){a.handleKey(b)}}(this)),$("#facebook").click(this.post2fb),!0}return $("#status").html("Sorry but your browser doesn't support HTML5 canvas!"),$("#main_container").hide(),$("#score_container").hide(),!1},unpause:function(){this._isPause=!1,$(".overlay").unbind("mouseenter mouseleave click"),$("#main_container .overlay").fadeOut("fast"),$(".overlay .pause").hide(),this._audio.play(),this.Run()},pause:function(){this._isPause=!0,$(".overlay .text .before_start").hide(),$(".overlay .pause").show(),$("#main_container .overlay").fadeIn("fast"),$(".overlay").unbind("click mouseenter mouseleave"),$(".overlay").hover(function(){$("#pause_text").addClass("unpause"),$("#pause_text").html('<span class="grey">un</span>pause')},function(){$("#pause_text").removeClass("unpause"),$("#pause_text").html("pause")}),$(".overlay").click(function(a){return function(b){a.unpause(b)}}(this)),this.stopMusic(),clearInterval(this._drawTimer),clearInterval(this._scoreTimer),clearInterval(this._speedTimer),clearInterval(this._floorTimer),clearInterval(this._itemTimer)},handleKey:function(){this._audio.canPlayType&&(this._audio.volume=.125,this._audio.play(),setTimeout(function(a){return function b(){a._audio.volume+=.125,1>a._audio.volume&&setTimeout(b,250)}}(this),250)),$("#main_container .overlay").fadeOut("fast"),$("#score_container").fadeIn("fast"),$(document).unbind("keyup keydown"),$("#main_container").unbind("click"),$(document).bind("keyup keydown",function(a){return function(b){a.handleKey(b)}}(this._player)),$.browser.msie?$(document).bind("focusout",function(a){return function(b){a.pause(b)}}(this)):$(window).bind("blur",function(a){return function(b){a.pause(b)}}(this)),$("#mix").show(),this.Run()},Run:function(){this._drawTimer=setTimeout(function(a){a.Update()},this._updateInterval,this),this._scoreTimer=setInterval(function(a){a.UpdateScore()},50,this),this._speedTimer=setTimeout(function(a){a.Accelerate()},this._accelInterval,this),this._floorTimer=setTimeout(function(a){a.NewFloor()},Math.floor(Math.random(3e3)+500),this),this._itemTimer=setInterval(function(a){a.NewItem()},1e3,this)},NewFloor:function(){var a=new Floor(this._player._y,this);this._floor[a._y].push(a);var b=Math.random();this._isLost||this._isPause||(this._floorTimer=setTimeout(function(a){a.NewFloor()},Math.floor(2e3*b>500?2e3*b:500),this))},NewItem:function(){var a=Math.random();if(a>.6){var b=new Item(this._player._y,this);this._item[b._y].push(b)}},Accelerate:function(){(this._isPause||this._isLost)&&clearInterval(this._speedTimer),20>=this._updateInterval?(this._speed*=2,this._updateInterval*=2,this._accelInterval*=2):this._updateInterval/=1.0625,this._speedTimer=setTimeout(function(a){a.Accelerate()},this._accelInterval,this)},moreAccelerate:function(){this._isLost&&clearInterval(this._speedTimer),this._speed*=1.0625},UpdateScore:function(){this._score++,this._grand=this._score*this._multiplier,this._score_box.html(this._score),this._mul_box.html(this._multiplier),this._grand_box.html((""+this._grand).replace(/\B(?=(?:\d{3})+(?!\d))/g,","))},Update:function(){this._canvasBufferContext.clearRect(0,0,this._canvas.width,this._canvas.height);for(var b=this._floor.length;b--;){for(var c=this._floor[b].length;c--;){var d=this._floor[b][c];d.isLeave?(delete d,this._floor[b].splice(c,1)):(d.Update(this._speed),d&&d.Draw(this._canvasBufferContext))}for(var c=this._item[b].length;c--;){var e=this._item[b][c];e.isLeave?(delete e,this._item[b].splice(c,1)):(e.Update(this._speed),e&&e.Draw(this._canvasBufferContext))}}this._player.Update(this._speed),this._player.Draw(this._canvasBufferContext),this._canvasContext.clearRect(0,0,this._canvas.width,this._canvas.height),this._canvasContext.drawImage(this._canvasBuffer,0,0),this._isPause||this._isLost||(this._drawTimer=setTimeout(function(a){a.Update()},this._updateInterval,this))}},$(document).ready(function(){var a=new Game;a.Init(),void 0!==window.FB&&(FB.init({appId:0x9dde36b30609,channelUrl:"//dl.dropbox.com/u/1629873/facebook/dot/channel.html",status:!0,cookie:!0,xfbml:!0}),$("#login").click(function(){login()}),FB.getLoginStatus(function(a){"unknown"===a.status&&($("#control").hide(),$("#status").html("...if you logged in to Facebook!"),$("#login").show())}),FB.Canvas.setSize()),$("#retry_text").click(function(){window.location.reload(!1)})});